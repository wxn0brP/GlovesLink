var c=class{ws;constructor(s){this.ws=new WebSocket(s)}onOpen(s){this.ws.addEventListener("open",s)}onMessage(s){this.ws.addEventListener("message",n=>s(n.data))}onClose(s){this.ws.addEventListener("close",s)}onError(s){this.ws.addEventListener("error",s)}send(s){this.ws.send(s)}close(){this.ws.close()}static fixUrl(s){return s.startsWith("/")&&(s=window.location.host+s),!s.startsWith("ws://")&&!s.startsWith("wss://")&&(s=(window?.location?.protocol==="https:"?"wss://":"ws://")+s),s}};var d=class{ws;ackIdCounter;ackCallbacks;handlers;opts;url;constructor(s,n={}){this.ackIdCounter=1,this.ackCallbacks=new Map,this.handlers={},this.opts={logs:!1,reConnect:!0,reConnectInterval:1e3,token:null,...n},this.url=c.fixUrl(s),this.opts.token&&(this.url+=`?token=${this.opts.token}`),this._connect()}_connect(){let s=Date.now().toString(36)+Math.random().toString(36).substring(2,10),n=this.url.includes("?")?`${this.url}&id=${s}`:`${this.url}?id=${s}`;this.ws=new c(n),this.ws.onOpen(()=>{this.opts.logs&&console.log("[ws] Connected"),this.handlers.connect?.(this.ws)}),this.ws.onError((...e)=>{this.opts.logs&&console.warn("[ws] Error:",e),this.handlers.error?.(...e)}),this.ws.onMessage(e=>{let t;try{t=JSON.parse(e)}catch{this.opts.logs&&console.warn("[ws] Invalid JSON:",e);return}if("ack"in t){let r=t.ack,a=this.ackCallbacks.get(r);a&&(this.ackCallbacks.delete(r),a(...t.data));return}let{evt:o,data:i,ackI:l}=t;if(!o||i&&!Array.isArray(i))return;if(Array.isArray(l))for(let r=0;r<l.length;r++){let a=l[r];if(!i[a])break;let f=i[a];i[a]=(...w)=>{this.ws.send(JSON.stringify({ack:f,data:w}))}}let h=this.handlers[o];h&&h(...i)}),this.ws.onClose(e=>{if(this.opts.logs&&console.log("[ws] Disconnected",e),this.handlers.disconnect?.(this.ws,e),e.code===1006){this.opts.logs&&console.log("[ws] Connection closed by server"),fetch("/gloves-link/status?id="+s).then(t=>t.json()).then(t=>{if(t.err){this.opts.logs&&console.log("[ws] Status error",t.msg);return}let o=t.status;this.opts.logs&&console.log("[ws] Status",o),o===401?this.handlers.unauthorized?.(this.ws):o===403?this.handlers.forbidden?.(this.ws):o===500&&this.handlers.serverError?.(this.ws)});return}this.opts.reConnect&&setTimeout(()=>{this._connect()},this.opts.reConnectInterval)})}on(s,n){this.handlers[s]=n}emit(s,...n){let e=n.map((t,o)=>{if(typeof t=="function")return o}).filter(t=>t!==void 0);for(let t=0;t<e.length;t++){let o=e[t],i=this.ackIdCounter++;this.ackCallbacks.set(i,n[o]),n[o]=i}this.ws.send(JSON.stringify({evt:s,data:n||void 0,ackI:e.length?e:void 0}))}send(s,...n){return this.emit(s,...n)}close(){this.ws.close()}};export{d as GLC,d as GlovesLinkClient,d as client,d as default};
//# sourceMappingURL=GlovesLinkClient.js.map
