{
  "version": 3,
  "sources": ["../src/universal.ts", "../src/index.ts"],
  "sourcesContent": ["let WebSocketImpl: any;\n\nif (typeof window === \"undefined\") {\n    const { WebSocket } = await import(\"ws\");\n    WebSocketImpl = WebSocket;\n} else {\n    WebSocketImpl = window.WebSocket;\n}\n\nexport default WebSocketImpl;", "import WebSocketImpl from \"./universal\";\n\nexport interface GLC_Opts {\n    reConnect: boolean,\n    reConnectInterval: number,\n    logs: boolean;\n    token: string;\n}\n\nexport interface GLC_DataEvent {\n    evt: string;\n    data: any[];\n    ackI?: number[];\n}\n\nexport interface GLC_AckEvent {\n    ack: number;\n    data: any[];\n}\n\nexport class GlovesLinkClient {\n    public ws: WebSocket;\n    public ackIdCounter: number;\n    public ackCallbacks: Map<number, Function>;\n    public handlers: { [key: string]: Function };\n    public opts: GLC_Opts;\n    public url: URL;\n\n    constructor(url: string, opts: Partial<GLC_Opts> = {}) {\n        this.ackIdCounter = 1;\n        this.ackCallbacks = new Map();\n        this.handlers = {};\n        this.opts = {\n            logs: false,\n            reConnect: true,\n            reConnectInterval: 1000,\n            token: null,\n            ...opts\n        }\n\n        this.url = new URL(url, window ? window.location.href.replace(\"http\", \"ws\") : \"ws://localhost\");\n        if (this.opts.token) this.url.searchParams.set(\"token\", this.opts.token);\n\n        this._connect();\n    }\n\n    _connect() {\n        const id = Date.now().toString(36) + Math.random().toString(36).substring(2, 10);\n        this.url.searchParams.set(\"id\", id);\n        this.ws = new WebSocketImpl(this.url.href);\n\n        this.ws.onopen = () => {\n            if (this.opts.logs) console.log(\"[ws] Connected\");\n            this.handlers.connect?.(this.ws);\n        }\n\n        this.ws.onerror = (...err: any) => {\n            if (this.opts.logs) console.warn(\"[ws] Error:\", err);\n            this.handlers.error?.(...err);\n        }\n\n        this.ws.onmessage = (_data) => {\n            const raw = _data?.data?.toString() || _data?.toString() || \"\";\n            let msg: GLC_DataEvent | GLC_AckEvent;\n\n            try {\n                msg = JSON.parse(raw);\n            } catch {\n                if (this.opts.logs) console.warn(\"[ws] Invalid JSON:\", raw);\n                return;\n            }\n\n            if (\"ack\" in msg) {\n                const ackId = msg.ack;\n                const ackCallback = this.ackCallbacks.get(ackId);\n                if (ackCallback) {\n                    this.ackCallbacks.delete(ackId);\n                    ackCallback(...msg.data);\n                }\n                return;\n            }\n\n            const { evt, data, ackI } = msg;\n            if (!evt || (data && !Array.isArray(data))) return;\n\n            if (Array.isArray(ackI)) {\n                for (let i = 0; i < ackI.length; i++) {\n                    const ackIndex = ackI[i];\n                    if (!data[ackIndex]) break;\n\n                    const ackId = data[ackIndex];\n                    data[ackIndex] = (...res: any) => {\n                        this.ws.send(JSON.stringify({\n                            ack: ackId,\n                            data: res\n                        }));\n                    };\n                }\n            }\n\n            const handler = this.handlers[evt];\n            if (!handler) return;\n\n            handler(...data);\n        }\n\n        this.ws.onclose = (event: CloseEvent) => {\n            if (this.opts.logs) console.log(\"[ws] Disconnected\", event);\n            this.handlers.disconnect?.(this.ws, event);\n\n            if (event.code === 1006) {\n                if (this.opts.logs) console.log(\"[ws] Connection closed by server\");\n                fetch(\"/gloves-link/status?id=\" + id).then(res => res.json()).then(data => {\n                    if (data.err) {\n                        if (this.opts.logs) console.log(\"[ws] Status error\", data.msg);\n                        return;\n                    }\n                    const status = data.status as number;\n                    if (this.opts.logs) console.log(\"[ws] Status\", status);\n                    if (status === 401) this.handlers.unauthorized?.(this.ws);\n                    else if (status === 403) this.handlers.forbidden?.(this.ws);\n                    else if (status === 500) this.handlers.serverError?.(this.ws);\n                })\n                return;\n            }\n            if (!this.opts.reConnect) return;\n\n            setTimeout(() => {\n                this._connect();\n            }, this.opts.reConnectInterval);\n        }\n    }\n\n    on(evt: string, handler: (...args: any[]) => void | any) {\n        this.handlers[evt] = handler;\n    }\n\n    emit(evt: string, ...args: any[]) {\n        const ackI = args.map((data, i) => {\n            if (typeof data === \"function\") return i;\n        }).filter(i => i !== undefined);\n\n        for (let i = 0; i < ackI.length; i++) {\n            const ackIndex = ackI[i];\n            const ackId = this.ackIdCounter++;\n            this.ackCallbacks.set(ackId, args[ackIndex]);\n            args[ackIndex] = ackId;\n        }\n\n        this.ws.send(JSON.stringify({\n            evt,\n            data: args || undefined,\n            ackI: ackI.length ? ackI : undefined\n        }));\n    }\n\n    send(evt: string, ...args: any[]) {\n        return this.emit(evt, ...args);\n    }\n\n    close() {\n        this.ws.close();\n    }\n}\n\nexport {\n    GlovesLinkClient as default,\n    GlovesLinkClient as GLC,\n    GlovesLinkClient as client,\n}"],
  "mappings": "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",
  "names": ["WebSocketImpl", "WebSocket", "universal_default", "GlovesLinkClient", "url", "opts", "id", "universal_default", "err", "_data", "raw", "msg", "ackId", "ackCallback", "evt", "data", "ackI", "i", "ackIndex", "res", "handler", "event", "status", "args"]
}
